name: Build APK from URL

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'GitHub or GitLab repo URL of the Android project'
        required: true
      branch:
        description: 'Branch or tag to build (optional)'
        required: false
      module_name:
        description: 'Gradle module name (e.g., app) for APK output'
        required: false
        default: 'app'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # Prevent hanging jobs

    steps:
      - name: Checkout code
        run: |
          git clone "${{ github.event.inputs.repo_url }}" project
          if [ $? -ne 0 ]; then
            echo "❌ Failed to clone repository"
            exit 1
          fi
          cd project
          if [ -n "${{ github.event.inputs.branch }}" ]; then
            git checkout "${{ github.event.inputs.branch }}"
            if [ $? -ne 0 ]; then
              echo "❌ Failed to checkout branch: ${{ github.event.inputs.branch }}"
              exit 1
            fi
          fi
        shell: bash

      - name: Prepare project
        run: |
          if [ ! -f project/build.gradle ]; then
            echo "❌ No build.gradle found in repository root"
            exit 1
          fi
          mv project/* .
          rm -rf project
        shell: bash

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Make Gradle Wrapper executable
        run: chmod +x ./gradlew

      - name: Build Debug APK
        run: |
          if [ ! -f gradlew ]; then
            echo "❌ Gradle Wrapper (gradlew) not found"
            exit 1
          fi
          ./gradlew assembleDebug --no-daemon
        shell: bash

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: ${{ github.event.inputs.module_name }}/build/outputs/apk/**/*.apk
          retention-days: 7

